# æ€§èƒ½ä¼˜åŒ–å®è·µ

---
tags: [æ€§èƒ½ä¼˜åŒ–, å†…å­˜åˆ†æ, Redisä¼˜åŒ–, JVMè°ƒä¼˜, æ•°æ®åº“ä¼˜åŒ–]
created: 2026-02-21
updated: 2026-02-21
status: æŒç»­æ›´æ–°
importance: â­â­â­â­â­
---

## ğŸ¯ æ ¸å¿ƒè¦ç‚¹
> ç³»ç»Ÿæ€§èƒ½ä¼˜åŒ–çš„å®æˆ˜ç»éªŒå’Œæ–¹æ³•è®º

- **å†…å­˜ä¼˜åŒ–**ï¼šJVM å†…å­˜åˆ†æå’Œæ³„éœ²æ’æŸ¥
- **Redis ä¼˜åŒ–**ï¼šç¼“å­˜æ€§èƒ½è°ƒä¼˜å’Œé—®é¢˜è¯Šæ–­
- **æ•°æ®åº“ä¼˜åŒ–**ï¼šæŸ¥è¯¢æ€§èƒ½å’Œç´¢å¼•ä¼˜åŒ–
- **å¾®æœåŠ¡ä¼˜åŒ–**ï¼šæœåŠ¡é—´è°ƒç”¨å’Œè´Ÿè½½å‡è¡¡ä¼˜åŒ–

## ğŸ§  JVM å†…å­˜ä¼˜åŒ–

### å†…å­˜æ³„éœ²è¯Šæ–­æµç¨‹

#### 1. é—®é¢˜è¯†åˆ«
**å¸¸è§ç—‡çŠ¶**ï¼š
- åº”ç”¨å“åº”å˜æ…¢
- é¢‘ç¹ Full GC
- OutOfMemoryError
- å†…å­˜ä½¿ç”¨æŒç»­å¢é•¿

#### 2. å †è½¬å‚¨ç”Ÿæˆ

**é¢„é…ç½®è‡ªåŠ¨è½¬å‚¨**ï¼š
```bash
# ç”Ÿäº§ç¯å¢ƒæ¨èé…ç½®
java \
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/dump/heapdump.hprof \
  -XX:+PrintGCDetails \
  -XX:+PrintGCTimeStamps \
  -Xloggc:/logs/gc.log \
  -jar application.jar
```

**Docker ç¯å¢ƒé…ç½®**ï¼š
```bash
docker run -d \
  -v /host/dump:/dump \
  -v /host/logs:/logs \
  your-image \
  java -XX:+HeapDumpOnOutOfMemoryError \
       -XX:HeapDumpPath=/dump/heapdump.hprof \
       -jar app.jar
```

**æ‰‹åŠ¨è½¬å‚¨**ï¼š
```bash
# è·å–è¿›ç¨‹ PID
jps -l

# ç”Ÿæˆå †è½¬å‚¨ï¼ˆåªåŒ…å«å­˜æ´»å¯¹è±¡ï¼‰
jmap -dump:live,format=b,file=heapdump.hprof PID

# æŸ¥çœ‹å †å†…å­˜ä½¿ç”¨æƒ…å†µ
jmap -histo:live PID | head -20
```

#### 3. MAT å·¥å…·åˆ†æ

**å…³é”®åˆ†ææ­¥éª¤**ï¼š

1. **Leak Suspects æŠ¥è¡¨**
   - è‡ªåŠ¨è¯†åˆ«å†…å­˜æ³„éœ²å«Œç–‘ç‚¹
   - æä¾›è¯¦ç»†çš„å¼•ç”¨é“¾åˆ†æ
   - æ˜¾ç¤ºå ç”¨å†…å­˜æœ€å¤§çš„å¯¹è±¡

2. **Histogram è§†å›¾**
   - æŒ‰ç±»å‹ç»Ÿè®¡å¯¹è±¡æ•°é‡å’Œå†…å­˜å ç”¨
   - è¯†åˆ«å¼‚å¸¸å¢é•¿çš„å¯¹è±¡ç±»å‹
   - åˆ†æå¯¹è±¡å¼•ç”¨å…³ç³»

3. **Dominator Tree**
   - æ˜¾ç¤ºå¯¹è±¡çš„æ”¯é…å…³ç³»
   - æ‰¾å‡ºå†…å­˜å ç”¨çš„æ ¹æœ¬åŸå› 
   - åˆ†æå¯¹è±¡çš„ç”Ÿå‘½å‘¨æœŸ

**å®é™…æ¡ˆä¾‹åˆ†æ**ï¼š
```
é—®é¢˜ï¼šé˜¿é‡Œäº‘ SDK å®¢æˆ·ç«¯å¯¹è±¡æ³„éœ²
ç°è±¡ï¼šå†…å­˜æŒç»­å¢é•¿ï¼Œå¤§é‡ Client å¯¹è±¡æœªé‡Šæ”¾
åŸå› ï¼šæ¯æ¬¡è°ƒç”¨éƒ½ new Clientï¼Œä½¿ç”¨åæœªå…³é—­
è§£å†³ï¼šæ”¹ä¸ºå•ä¾‹æ¨¡å¼æˆ–ä½¿ç”¨ååŠæ—¶å…³é—­
```

#### 4. æ€§èƒ½ç›‘æ§æŒ‡ä»¤

```bash
# GC æƒ…å†µç›‘æ§
jstat -gc PID 1000  # æ¯ç§’è¾“å‡ºä¸€æ¬¡

# å †æ ˆä¿¡æ¯
jstack PID

# çº¿ç¨‹è½¬å‚¨
jcmd PID Thread.print

# JVM å‚æ•°æŸ¥çœ‹
jcmd PID VM.flags
```

### JVM è°ƒä¼˜å‚æ•°

#### å †å†…å­˜é…ç½®
```bash
# åŸºç¡€å†…å­˜é…ç½®
-Xms2g          # åˆå§‹å †å¤§å°
-Xmx4g          # æœ€å¤§å †å¤§å°
-Xmn1g          # æ–°ç”Ÿä»£å¤§å°
-XX:MetaspaceSize=256m  # å…ƒç©ºé—´åˆå§‹å¤§å°

# åƒåœ¾æ”¶é›†å™¨é€‰æ‹©
-XX:+UseG1GC    # ä½¿ç”¨ G1 åƒåœ¾æ”¶é›†å™¨
-XX:MaxGCPauseMillis=200  # æœ€å¤§ GC æš‚åœæ—¶é—´

# GC æ—¥å¿—é…ç½®
-XX:+PrintGC
-XX:+PrintGCDetails
-XX:+PrintGCTimeStamps
-Xloggc:gc.log
```

## ğŸš€ Redis æ€§èƒ½ä¼˜åŒ–

### CPU é«˜é—®é¢˜è¯Šæ–­

#### 1. æ…¢æŸ¥è¯¢åˆ†æ
```bash
# æŸ¥çœ‹æ…¢æŸ¥è¯¢é…ç½®
CONFIG GET slowlog-*

# è·å–æ…¢æŸ¥è¯¢è®°å½•
SLOWLOG LEN
SLOWLOG GET 100

# è®¾ç½®æ…¢æŸ¥è¯¢é˜ˆå€¼ï¼ˆå¾®ç§’ï¼‰
CONFIG SET slowlog-log-slower-than 10000
```

#### 2. å‘½ä»¤ç»Ÿè®¡åˆ†æ
```bash
# æŸ¥çœ‹å‘½ä»¤æ‰§è¡Œç»Ÿè®¡
INFO commandstats

# é‡ç½®ç»Ÿè®¡ä¿¡æ¯
CONFIG RESETSTAT
```

**åˆ†ææŒ‡æ ‡**ï¼š
- `calls`ï¼šæ‰§è¡Œæ€»æ¬¡æ•°
- `usec`ï¼šæ€»è€—æ—¶ï¼ˆå¾®ç§’ï¼‰
- `usec_per_call`ï¼šå¹³å‡æ‰§è¡Œæ—¶é—´

#### 3. å®æ—¶ç›‘æ§
```bash
# å®æ—¶ç›‘æ§æ‰€æœ‰å‘½ä»¤
MONITOR

# å¯¼å‡ºç›‘æ§æ—¥å¿—è¿›è¡Œåˆ†æ
redis-cli -h 127.0.0.1 -p 6379 -a password monitor > redis_monitor.log

# åˆ†æç›‘æ§æ—¥å¿—
cat redis_monitor.log | grep SCAN | wc -l  # ç»Ÿè®¡ SCAN å‘½ä»¤æ¬¡æ•°
cat redis_monitor.log | grep "1656161170" | wc -l  # ç»Ÿè®¡æŸç§’çš„å‘½ä»¤æ•°
```

### æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

#### 1. é¿å…å±é™©å‘½ä»¤
```bash
# âŒ é¿å…ä½¿ç”¨çš„å‘½ä»¤
KEYS *          # ä¼šé˜»å¡ Redis
FLUSHALL        # æ¸…ç©ºæ‰€æœ‰æ•°æ®
FLUSHDB         # æ¸…ç©ºå½“å‰æ•°æ®åº“

# âœ… æ¨èæ›¿ä»£æ–¹æ¡ˆ
SCAN 0 MATCH pattern COUNT 100  # æ›¿ä»£ KEYS
```

#### 2. æ•°æ®ç»“æ„ä¼˜åŒ–
```bash
# ä½¿ç”¨åˆé€‚çš„æ•°æ®ç»“æ„
HSET user:1001 name "å¼ ä¸‰" age 25  # å“ˆå¸Œè¡¨å­˜å‚¨å¯¹è±¡
ZADD leaderboard 100 "player1"    # æœ‰åºé›†åˆåšæ’è¡Œæ¦œ
SETBIT online_users 1001 1        # ä½å›¾ç»Ÿè®¡åœ¨çº¿ç”¨æˆ·
```

#### 3. å†…å­˜ä¼˜åŒ–
```bash
# æŸ¥çœ‹å†…å­˜ä½¿ç”¨æƒ…å†µ
INFO memory

# è®¾ç½®è¿‡æœŸç­–ç•¥
CONFIG SET maxmemory-policy allkeys-lru

# å¯ç”¨å‹ç¼©
hash-max-ziplist-entries 512
hash-max-ziplist-value 64
```

## ğŸ—„ï¸ æ•°æ®åº“æ€§èƒ½ä¼˜åŒ–

### æŸ¥è¯¢ä¼˜åŒ–

#### 1. ç´¢å¼•ä¼˜åŒ–
```sql
-- åˆ†ææŸ¥è¯¢æ‰§è¡Œè®¡åˆ’
EXPLAIN SELECT * FROM users WHERE status = 'active' AND create_time > '2024-01-01';

-- åˆ›å»ºå¤åˆç´¢å¼•
CREATE INDEX idx_user_status_time ON users(status, create_time);

-- æŸ¥çœ‹ç´¢å¼•ä½¿ç”¨æƒ…å†µ
SHOW INDEX FROM users;
```

#### 2. æ…¢æŸ¥è¯¢åˆ†æ
```sql
-- å¼€å¯æ…¢æŸ¥è¯¢æ—¥å¿—
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;

-- æŸ¥çœ‹æ…¢æŸ¥è¯¢
SELECT * FROM mysql.slow_log ORDER BY start_time DESC LIMIT 10;
```

### è¿æ¥æ± ä¼˜åŒ–

#### HikariCP é…ç½®
```yaml
spring:
  datasource:
    hikari:
      maximum-pool-size: 20      # æœ€å¤§è¿æ¥æ•°
      minimum-idle: 5            # æœ€å°ç©ºé—²è¿æ¥
      connection-timeout: 30000  # è¿æ¥è¶…æ—¶æ—¶é—´
      idle-timeout: 600000       # ç©ºé—²è¶…æ—¶æ—¶é—´
      max-lifetime: 1800000      # è¿æ¥æœ€å¤§ç”Ÿå‘½å‘¨æœŸ
      leak-detection-threshold: 60000  # è¿æ¥æ³„éœ²æ£€æµ‹
```

## ğŸŒ å¾®æœåŠ¡æ€§èƒ½ä¼˜åŒ–

### è´Ÿè½½å‡è¡¡ä¼˜åŒ–

#### 1. è‡ªå®šä¹‰è´Ÿè½½å‡è¡¡ç­–ç•¥
```java
@Component
public class GrayLoadBalancer implements ReactorServiceInstanceLoadBalancer {

    @Override
    public Mono<Response<ServiceInstance>> choose(Request request) {
        // æ ¹æ®è¯·æ±‚å¤´è¿›è¡Œç°åº¦è·¯ç”±
        String grayFlag = getGrayFlag(request);

        return serviceInstanceListSupplier.get(request)
            .next()
            .map(instances -> {
                if ("gray".equals(grayFlag)) {
                    // è·¯ç”±åˆ°ç°åº¦å®ä¾‹
                    return selectGrayInstance(instances);
                } else {
                    // è·¯ç”±åˆ°æ­£å¸¸å®ä¾‹
                    return selectNormalInstance(instances);
                }
            });
    }
}
```

#### 2. ä¼˜é›…ä¸‹çº¿é…ç½®
```yaml
# Nacos æƒé‡é…ç½®
spring:
  cloud:
    nacos:
      discovery:
        metadata:
          version: v1.0
          weight: 100  # è®¾ç½®ä¸º 0 å®ç°ä¼˜é›…ä¸‹çº¿
```

### æœåŠ¡è°ƒç”¨ä¼˜åŒ–

#### 1. Feign è¶…æ—¶é…ç½®
```yaml
feign:
  client:
    config:
      default:
        connect-timeout: 5000
        read-timeout: 10000
  httpclient:
    enabled: true
    max-connections: 200
    max-connections-per-route: 50
```

#### 2. ç†”æ–­å™¨é…ç½®
```yaml
resilience4j:
  circuitbreaker:
    instances:
      userService:
        failure-rate-threshold: 50
        wait-duration-in-open-state: 30s
        sliding-window-size: 10
```

## ğŸ“Š ç›‘æ§å’Œå‘Šè­¦

### åº”ç”¨ç›‘æ§æŒ‡æ ‡

#### 1. JVM ç›‘æ§
- å †å†…å­˜ä½¿ç”¨ç‡
- GC é¢‘ç‡å’Œè€—æ—¶
- çº¿ç¨‹æ•°é‡
- CPU ä½¿ç”¨ç‡

#### 2. ä¸šåŠ¡ç›‘æ§
- æ¥å£å“åº”æ—¶é—´
- é”™è¯¯ç‡
- QPS/TPS
- æ•°æ®åº“è¿æ¥æ± ä½¿ç”¨ç‡

#### 3. åŸºç¡€è®¾æ–½ç›‘æ§
- æœåŠ¡å™¨ CPUã€å†…å­˜ã€ç£ç›˜
- ç½‘ç»œå»¶è¿Ÿ
- Redis æ€§èƒ½æŒ‡æ ‡
- æ•°æ®åº“æ€§èƒ½æŒ‡æ ‡

### å‘Šè­¦ç­–ç•¥
```yaml
# ç¤ºä¾‹å‘Šè­¦è§„åˆ™
alerts:
  - name: high_memory_usage
    condition: jvm_memory_used_bytes / jvm_memory_max_bytes > 0.8
    duration: 5m

  - name: high_response_time
    condition: http_request_duration_seconds > 2
    duration: 2m

  - name: high_error_rate
    condition: http_requests_total{status=~"5.."} / http_requests_total > 0.05
    duration: 1m
```

## ğŸ”— ç›¸å…³æ–‡æ¡£
- **é—®é¢˜è§£å†³**ï¼š[[06-é¡¹ç›®å®æˆ˜/é¡¹ç›®é—®é¢˜æ€»ç»“.md]]
- **æŠ€æœ¯åŸç†**ï¼š[[04-mysql.md]] [[06-mq.md#Redis]]
- **å·¥å…·ç¯å¢ƒ**ï¼š[[07-å·¥å…·ç¯å¢ƒ/éƒ¨ç½²è¿ç»´å®è·µ.md]]

## ğŸ·ï¸ æ ‡ç­¾
#æ€§èƒ½ä¼˜åŒ– #JVMè°ƒä¼˜ #Redisä¼˜åŒ– #æ•°æ®åº“ä¼˜åŒ– #å¾®æœåŠ¡ #ç›‘æ§å‘Šè­¦