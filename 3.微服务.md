# 微服务

其他：

- resttemplate使用
- pom详解 dependencyManagement
- idea 启动 设置各种参数 port env参数
- jmeter 使用
- 日志 logback

## 注册中心

**nacos**

注册中心、配置中心、服务管理 平台

注册中心演变：

跨进程通信 RPC ，使用 http 请求进行数据访问获取。然后各服务把自己的地址记到一个表中，每次去查询表，获取地址。

如果完成上面的功能，需要什么？

1. 一个服务用来管理和维护这些注册表
2. 客户端通过请求将自身的地址等信息告诉服务
3. 客户端通过请求将注册表拉取到本地，每隔一段时间都需要重复更新
4. 客户端发送心跳，证明自己还在，同时服务端检测客户端是否健康，否则停掉

综合如下图：

![image-20230829103208613](pic/image-20230829103208613.png)

nacos如下：

![nacos](pic/nacos.png)

CAP C 一致性 A 可用性 P 分区容错

## 负载均衡

负载均衡 硬件 F5、软件 nginx、客户端自己做的负载均衡

**ribbon**

属于 netflix ，目前已经不在维护，可使用 loadbalancer，可自己实现，重写 choose 方法，搭建灰度发布功能

loadbalancer 支持 webclient（webflux），ribbon 不支持

常见负载均衡算法

- 随机：随机选择，使用很少
- 轮训：默认算法，定义变量，每次请求变量+1，然后和服务数取模，模几用几
- 加权：把所有权重排列成一个数据，然后请求随机落在某一个区间，如：20% 80%( 0-20, 20-99)
- 地址hash：根据 ip 进行 hash 进行选择，想 hashmap 一样
- 最小链接数：根据积压数等参数，将请求分配在压力最小的服务器上

## 跨进程通讯 RPC

不在一个服务上，如何请求数据，通过 http 请求调用数据。

http 选择：httpclient、okhttp、httpurlconnection、resttemplate、webclient（webflux）

**openfeign** 原理

请求过程



## 流量控制

应对洪峰流量：秒杀、大促、下单、订单回流处理

消息性场景：削峰填谷、冷热启动

付费系统：根据使用流量付费

API Gateway：精准控制 API 流量

任何应用：探测应用中运行的慢程序块，进行限制

**sentinel** 原理

使用：

1.dashboard 控制台

2.代码写规则

3.注解方式（推荐）

```
添加依赖
<!-- sentinel 流控管理 -->
<dependency>
	<groupId>com.alibaba.cloud</groupId>
	<artifactId>spring-cloud-starter-alibaba-sentinel</artifactId>
</dependency>

<!-- sentinel 看板 -->
<dependency>
	<groupId>com.alibaba.csp</groupId>
	<artifactId>sentinel-transport-simple-http</artifactId>
	<version>1.8.6</version>
</dependency>

<!-- sentinel 规则管理 -->
<dependency>
	<groupId>com.alibaba.csp</groupId>
	<artifactId>sentinel-datasource-nacos</artifactId>
</dependency>
```

```
@GetMapping("/env")
// 添加资源注解 转发方法  同时指定  block 优先级最高
@SentinelResource(value = "env", blockHandler = "envHandler", fallback = "envFallback")
public String env(String str) {
	return str + "当前环境：" + env;
}

// 方法必须 public 且返回数据、参数与原方法都要保持一致
public String envHandler(String str, BlockException ex) {
	return ex.getMessage() + "阻塞后返回的数据";
}

// 方法必须 public 且返回数据、参数与原方法都要保持一致
public String envFallback(String str, Throwable ex) {
	return ex.getMessage() + "异常后返回的数据";
}
```

统一异常处理 blockexceptionhandler

流控规则

QPS 信号量

## 分布式事务

seta

## 网关

gateway

## 链路追踪

skywalking