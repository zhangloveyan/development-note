# æ¶ˆæ¯é˜Ÿåˆ— - åŸç†

---
tags: [æ¶ˆæ¯é˜Ÿåˆ—, MQ, å¼‚æ­¥é€šä¿¡, åˆ†å¸ƒå¼ç³»ç»Ÿ, è§£è€¦]
created: 2026-02-21
updated: 2026-02-21
status: å·²æŒæ¡
importance: â­â­â­â­â­
---

## ğŸ¯ æ ¸å¿ƒè¦ç‚¹
> æ¶ˆæ¯é˜Ÿåˆ—çš„åŸºæœ¬åŸç†å’Œåº”ç”¨åœºæ™¯

- **å¼‚æ­¥é€šä¿¡**ï¼šè§£å†³ç³»ç»Ÿé—´çš„å¼‚æ­¥æ¶ˆæ¯ä¼ é€’é—®é¢˜
- **ç³»ç»Ÿè§£è€¦**ï¼šé™ä½ç³»ç»Ÿé—´çš„ç›´æ¥ä¾èµ–å…³ç³»
- **æµé‡å‰Šå³°**ï¼šç¼“è§£ç³»ç»Ÿç¬æ—¶é«˜å¹¶å‘å‹åŠ›
- **å¯é ä¼ è¾“**ï¼šä¿è¯æ¶ˆæ¯çš„å¯é æŠ•é€’å’Œå¤„ç†

## ğŸ’¡ åŸç†è¯¦è§£

### 1. æ¶ˆæ¯é˜Ÿåˆ—åŸºæœ¬æ¦‚å¿µ

æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆMessage Queueï¼‰æ˜¯ä¸€ç§åº”ç”¨ç¨‹åºé—´çš„é€šä¿¡æ–¹æ³•ï¼Œé€šè¿‡åœ¨æ¶ˆæ¯çš„ä¼ è¾“è¿‡ç¨‹ä¸­ä¿å­˜æ¶ˆæ¯æ¥å®ç°å¼‚æ­¥é€šä¿¡ã€‚

#### æ ¸å¿ƒç»„ä»¶
- **Producerï¼ˆç”Ÿäº§è€…ï¼‰**ï¼šå‘é€æ¶ˆæ¯çš„åº”ç”¨ç¨‹åº
- **Consumerï¼ˆæ¶ˆè´¹è€…ï¼‰**ï¼šæ¥æ”¶å’Œå¤„ç†æ¶ˆæ¯çš„åº”ç”¨ç¨‹åº
- **Messageï¼ˆæ¶ˆæ¯ï¼‰**ï¼šåœ¨åº”ç”¨ç¨‹åºé—´ä¼ è¾“çš„æ•°æ®
- **Queueï¼ˆé˜Ÿåˆ—ï¼‰**ï¼šå­˜å‚¨æ¶ˆæ¯çš„å®¹å™¨
- **Brokerï¼ˆä»£ç†ï¼‰**ï¼šæ¶ˆæ¯é˜Ÿåˆ—æœåŠ¡å™¨

### 2. æ¶ˆæ¯ä¼ é€’æ¨¡å¼

#### ç‚¹å¯¹ç‚¹æ¨¡å¼ï¼ˆP2Pï¼‰
```
Producer â†’ Queue â†’ Consumer
```
- ä¸€ä¸ªæ¶ˆæ¯åªèƒ½è¢«ä¸€ä¸ªæ¶ˆè´¹è€…æ¶ˆè´¹
- æ¶ˆè´¹åæ¶ˆæ¯ä»é˜Ÿåˆ—ä¸­åˆ é™¤
- æ”¯æŒå¤šä¸ªæ¶ˆè´¹è€…ï¼Œä½†æ¯æ¡æ¶ˆæ¯åªè¢«æ¶ˆè´¹ä¸€æ¬¡

#### å‘å¸ƒè®¢é˜…æ¨¡å¼ï¼ˆPub/Subï¼‰
```
Publisher â†’ Topic â†’ Subscriber1
                 â†’ Subscriber2
                 â†’ Subscriber3
```
- ä¸€ä¸ªæ¶ˆæ¯å¯ä»¥è¢«å¤šä¸ªè®¢é˜…è€…æ¶ˆè´¹
- æ¶ˆæ¯å‘å¸ƒåˆ°ä¸»é¢˜ï¼ˆTopicï¼‰
- æ‰€æœ‰è®¢é˜…è¯¥ä¸»é¢˜çš„æ¶ˆè´¹è€…éƒ½ä¼šæ”¶åˆ°æ¶ˆæ¯

### 3. Spring Integrationæ¡†æ¶

Spring Integrationæ˜¯ä¸€ç§äº‹ä»¶é©±åŠ¨æ¶ˆæ¯æ¡†æ¶ï¼Œç”¨æ¥åœ¨ç³»ç»Ÿä¹‹é—´ä¼ é€’æ¶ˆæ¯ã€‚

#### æ ¸å¿ƒç»„ä»¶

**Messageï¼ˆæ¶ˆæ¯ï¼‰**
```java
public class Message<T> {
    private final MessageHeaders headers;
    private final T payload;
}
```

**MessageChannelï¼ˆæ¶ˆæ¯é€šé“ï¼‰**
- ç”¨äºè§£è€¦ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…
- å®ç°æ¶ˆæ¯å‘é€å’Œæ¥æ”¶

**MessageRouterï¼ˆæ¶ˆæ¯è·¯ç”±å™¨ï¼‰**
- æ§åˆ¶æ¶ˆæ¯è½¬å‘çš„Channel
- æ ¹æ®è§„åˆ™å°†æ¶ˆæ¯è·¯ç”±åˆ°ä¸åŒçš„é€šé“

**Service Activatorï¼ˆæœåŠ¡æ¿€æ´»å™¨ï¼‰**
- ç»‘å®šMessageHandlerå’ŒMessageChannel
- ç”¨äºæ¶ˆè´¹æ¶ˆæ¯

**Channel Adapterï¼ˆé€šé“é€‚é…å™¨ï¼‰**
- è¿æ¥MessageChannelå’Œå…·ä½“çš„æ¶ˆæ¯ç«¯ç‚¹
- å¦‚è¿æ¥åˆ°MQTTã€AMQPç­‰åè®®

## ğŸ”§ ä»£ç ç¤ºä¾‹

### åŸºç¡€ç”¨æ³•

#### MQTTæ¶ˆæ¯å¤„ç†
```java
@Configuration
@EnableIntegration
public class MqttConfig {

    @Bean
    public MqttPahoClientFactory mqttClientFactory() {
        DefaultMqttPahoClientFactory factory = new DefaultMqttPahoClientFactory();
        MqttConnectOptions options = new MqttConnectOptions();
        options.setServerURIs(new String[] { "tcp://localhost:1883" });
        options.setUserName("username");
        options.setPassword("password".toCharArray());
        factory.setConnectionOptions(options);
        return factory;
    }

    // æ¶ˆæ¯å‘å¸ƒ
    @Bean
    @ServiceActivator(inputChannel = "mqttOutboundChannel")
    public MessageHandler mqttOutbound() {
        MqttPahoMessageHandler messageHandler =
            new MqttPahoMessageHandler("publisherClient", mqttClientFactory());
        messageHandler.setAsync(true);
        messageHandler.setDefaultTopic("test/topic");
        return messageHandler;
    }

    @Bean
    public MessageChannel mqttOutboundChannel() {
        return new DirectChannel();
    }

    // æ¶ˆæ¯è®¢é˜…
    @Bean
    public MessageProducerSupport mqttInbound() {
        MqttPahoMessageDrivenChannelAdapter adapter =
            new MqttPahoMessageDrivenChannelAdapter("consumerClient",
                mqttClientFactory(), "test/topic");
        adapter.setCompletionTimeout(5000);
        adapter.setConverter(new DefaultPahoMessageConverter());
        adapter.setQos(1);
        adapter.setOutputChannel(mqttInputChannel());
        return adapter;
    }

    @Bean
    public MessageChannel mqttInputChannel() {
        return new DirectChannel();
    }

    @ServiceActivator(inputChannel = "mqttInputChannel")
    public void handleMessage(String message) {
        System.out.println("æ”¶åˆ°æ¶ˆæ¯: " + message);
    }
}
```

#### RabbitMQé…ç½®
```java
@Configuration
@EnableRabbit
public class RabbitMqConfig {

    // åˆ›å»ºé˜Ÿåˆ—ã€äº¤æ¢æœºå’Œç»‘å®š
    @Bean
    public Declarables createQueuesAndExchanges() {
        Queue userQueue = new Queue("user.queue", true);
        Queue orderQueue = new Queue("order.queue", true);

        DirectExchange userExchange = new DirectExchange("user.exchange", true, false);
        DirectExchange orderExchange = new DirectExchange("order.exchange", true, false);

        return new Declarables(
            userQueue, orderQueue,
            userExchange, orderExchange,
            BindingBuilder.bind(userQueue).to(userExchange).with("user.create"),
            BindingBuilder.bind(orderQueue).to(orderExchange).with("order.create")
        );
    }

    // æ¶ˆæ¯å‘é€
    @Autowired
    private RabbitTemplate rabbitTemplate;

    public void sendUserMessage(User user) {
        rabbitTemplate.convertAndSend("user.exchange", "user.create", user);
    }

    // æ¶ˆæ¯æ¶ˆè´¹
    @RabbitListener(queues = "user.queue")
    public void handleUserMessage(User user) {
        System.out.println("å¤„ç†ç”¨æˆ·æ¶ˆæ¯: " + user);
    }

    // æ¶ˆæ¯ç¡®è®¤é…ç½®
    @Bean
    public RabbitListenerContainerFactory<?> rabbitListenerContainerFactory(
            ConnectionFactory connectionFactory) {
        SimpleRabbitListenerContainerFactory factory =
            new SimpleRabbitListenerContainerFactory();
        factory.setConnectionFactory(connectionFactory);
        factory.setAcknowledgeMode(AcknowledgeMode.MANUAL);
        factory.setConcurrentConsumers(2);
        factory.setPrefetchCount(1);
        return factory;
    }
}
```

### é«˜çº§ç”¨æ³•

#### æ¶ˆæ¯ç¡®è®¤æœºåˆ¶
```java
@Component
public class MessageProducer {

    @Autowired
    private RabbitTemplate rabbitTemplate;

    public void sendMessageWithConfirm(String message) {
        // è®¾ç½®ç¡®è®¤å›è°ƒ
        rabbitTemplate.setConfirmCallback((correlationData, ack, cause) -> {
            if (ack) {
                System.out.println("æ¶ˆæ¯å‘é€æˆåŠŸ");
            } else {
                System.err.println("æ¶ˆæ¯å‘é€å¤±è´¥: " + cause);
            }
        });

        // è®¾ç½®è¿”å›å›è°ƒ
        rabbitTemplate.setReturnsCallback(returned -> {
            System.err.println("æ¶ˆæ¯è¢«é€€å›: " + returned.getMessage());
        });

        rabbitTemplate.convertAndSend("exchange", "routing.key", message);
    }
}

@RabbitListener(queues = "test.queue")
public class MessageConsumer {

    @RabbitHandler
    public void handleMessage(String message, Channel channel,
                            @Header(AmqpHeaders.DELIVERY_TAG) long deliveryTag) {
        try {
            // å¤„ç†æ¶ˆæ¯
            processMessage(message);

            // æ‰‹åŠ¨ç¡®è®¤
            channel.basicAck(deliveryTag, false);
        } catch (Exception e) {
            try {
                // æ‹’ç»æ¶ˆæ¯å¹¶é‡æ–°å…¥é˜Ÿ
                channel.basicNack(deliveryTag, false, true);
            } catch (IOException ioException) {
                System.err.println("ç¡®è®¤æ¶ˆæ¯å¤±è´¥: " + ioException.getMessage());
            }
        }
    }

    private void processMessage(String message) {
        // ä¸šåŠ¡é€»è¾‘å¤„ç†
        System.out.println("å¤„ç†æ¶ˆæ¯: " + message);
    }
}
```

#### æ­»ä¿¡é˜Ÿåˆ—é…ç½®
```java
@Configuration
public class DeadLetterConfig {

    @Bean
    public Queue businessQueue() {
        return QueueBuilder.durable("business.queue")
                .withArgument("x-dead-letter-exchange", "dlx.exchange")
                .withArgument("x-dead-letter-routing-key", "dlx.routing.key")
                .withArgument("x-message-ttl", 60000) // æ¶ˆæ¯TTL 60ç§’
                .build();
    }

    @Bean
    public Queue deadLetterQueue() {
        return QueueBuilder.durable("dead.letter.queue").build();
    }

    @Bean
    public DirectExchange deadLetterExchange() {
        return new DirectExchange("dlx.exchange");
    }

    @Bean
    public Binding deadLetterBinding() {
        return BindingBuilder.bind(deadLetterQueue())
                .to(deadLetterExchange())
                .with("dlx.routing.key");
    }

    @RabbitListener(queues = "dead.letter.queue")
    public void handleDeadLetter(String message) {
        System.out.println("å¤„ç†æ­»ä¿¡æ¶ˆæ¯: " + message);
        // è®°å½•æ—¥å¿—ã€å‘é€å‘Šè­¦ç­‰
    }
}
```

#### å»¶è¿Ÿé˜Ÿåˆ—å®ç°
```java
@Configuration
public class DelayQueueConfig {

    // ä½¿ç”¨TTL + æ­»ä¿¡é˜Ÿåˆ—å®ç°å»¶è¿Ÿé˜Ÿåˆ—
    @Bean
    public Queue delayQueue() {
        return QueueBuilder.durable("delay.queue")
                .withArgument("x-dead-letter-exchange", "business.exchange")
                .withArgument("x-dead-letter-routing-key", "business.routing.key")
                .build();
    }

    @Bean
    public Queue businessQueue() {
        return QueueBuilder.durable("business.queue").build();
    }

    @Bean
    public DirectExchange businessExchange() {
        return new DirectExchange("business.exchange");
    }

    @Bean
    public Binding businessBinding() {
        return BindingBuilder.bind(businessQueue())
                .to(businessExchange())
                .with("business.routing.key");
    }

    // å‘é€å»¶è¿Ÿæ¶ˆæ¯
    public void sendDelayMessage(String message, int delaySeconds) {
        rabbitTemplate.convertAndSend("", "delay.queue", message, msg -> {
            msg.getMessageProperties().setExpiration(String.valueOf(delaySeconds * 1000));
            return msg;
        });
    }
}
```

## âš¡ æ€§èƒ½ç‰¹ç‚¹

| ç‰¹æ€§ | è¯´æ˜ | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| å¼‚æ­¥å¤„ç† | æé«˜ç³»ç»Ÿå“åº”é€Ÿåº¦ | è€—æ—¶æ“ä½œè§£è€¦ |
| å‰Šå³°å¡«è°· | ç¼“è§£ç¬æ—¶é«˜å¹¶å‘ | ç§’æ€ã€æŠ¢è´­åœºæ™¯ |
| ç³»ç»Ÿè§£è€¦ | é™ä½ç³»ç»Ÿé—´ä¾èµ– | å¾®æœåŠ¡æ¶æ„ |
| å¯é ä¼ è¾“ | ä¿è¯æ¶ˆæ¯ä¸ä¸¢å¤± | é‡‘èã€æ”¯ä»˜ç³»ç»Ÿ |

## ğŸ”— çŸ¥è¯†å…³è”

- **å‰ç½®çŸ¥è¯†**ï¼š[[åˆ†å¸ƒå¼ç³»ç»ŸåŸºç¡€]] [[Javaå¹¶å‘ç¼–ç¨‹]]
- **ç›¸å…³æŠ€æœ¯**ï¼š[[Kafkaå®æˆ˜]] [[RabbitMQå®æˆ˜]]
- **å®æˆ˜åº”ç”¨**ï¼š[[å¾®æœåŠ¡é€šä¿¡]] [[äº‹ä»¶é©±åŠ¨æ¶æ„]]
- **é—®é¢˜è§£å†³**ï¼š[[æ¶ˆæ¯é˜Ÿåˆ—é—®é¢˜è§£å†³]]

## ğŸ·ï¸ æ ‡ç­¾
#æ¶ˆæ¯é˜Ÿåˆ— #MQ #å¼‚æ­¥é€šä¿¡ #åˆ†å¸ƒå¼ç³»ç»Ÿ #Spring Integration #é¢è¯•é‡ç‚¹